<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" type="text/css" href="css/menustyle.css">
</head>
<body>
<section id="app">
  <header>
    <h1>Menu of the week</h1>
    <div class="header-line"></div>
  </header>

  <main>
    <week-table :recipes="recipes" :weekdays="weekdays"></week-table>
    <section id="user-interactive">
      <article>
        <add-recipe :recipes="recipes" :weekdays="weekdays" @save-recipe="saveRecipe"></add-recipe>
        <recipe-list :recipes="recipes"></recipe-list>
        <shopping-list :recipes="recipes"></shopping-list>
      </article>
    </section>
  </main>
</section>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<script>

    let eventBus = new Vue()

    Vue.component('week-table', {
        props: {
            recipes: {
                type: Array,
                required: true
            },
            weekdays: {
                type: Array,
                required: true
            }
        },
        template: `
          <article id="week-grid">
          <h2 v-for="weekday in weekdays">{{ weekday }}</h2>
          <figure v-for="recipe in recipes"
                  v-if="recipe.weekday"
                  :key="recipe.title"
                  :style="{gridArea: recipe.position()}"
                  @mouseover="hoveredWeekday=recipe.weekday"
                  @mouseleave="hoveredWeekday=''"
                  :class="{'hover-size': recipe.weekday===hoveredWeekday}"
                  @click="showRecipe">
            <img :src="recipe.image" :alt="recipe.alt" class="recipe-img">
            <figcaption>{{ recipe.title }}</figcaption>
          </figure>
          </article>
        `,
        data() {
            return {
                hoveredWeekday: '',
                displayRecipe: false
            }
        },
        methods: {
            showRecipe() {
                eventBus.$emit('hide-others')
                eventBus.$emit('show-recipe', this.hoveredWeekday)
                console.log('showRecipe called with weekday: ' + this.hoveredWeekday)
            }
        },
        mounted() {
            eventBus.$on('hide-others', () => this.displayRecipe = false)
        }
    })

    Vue.component('add-recipe', {
        props: {
            recipes: {
                type: Array,
                required: true
            },
            weekdays: {
                type: Array,
                required: true
            }
        },
        //todo style add ingredient button when both qty and weight are selected
        //todo lägg ut visningsläget på höger sida i egen component(och varje innehåll i egen? Eller här/varje article i egen?).
        template: `
          <section id="add-recipe">
          <button v-show="!showForm" @click="displayForm">Add a recipe</button>
          <form v-show="showForm"
                @submit.prevent="addRecipe">
            <p>
              <label for="title">Enter a recipe name:</label>
            </p>
            <p><input id="title"
                      name="title"
                      required
                      v-model="title"/></p>
            <p><label for="ingredients">Enter an ingredient:</label></p>
            <p><input id="ingredients"
                      name="ingredients"
                      v-model="ingredientName"></p>
            <p><label for="ingredient-qty">Select a quantity:</label></p>
            <p><input type="number"
                      id="ingredient-qty"
                      name="ingredient-qty"
                      min="1"
                      max="50"
                      v-model="ingredientQty"></p>
            <p><label for="ingredient-weight">Or, enter weight, measurement, etc:</label></p>
            <p><input id="ingredient-weight"
                      name="ingredient-weight"
                      v-model="ingredientWeight"></p>
            <p v-if="ingredientQty && ingredientWeight">Please enter either quantity or weight!</p>
            <p v-if="showIngredientError">Ingredient name required!</p>
            <p>
              <button @click.prevent="addIngredient">Add ingredient</button>
            </p>
            <p><label for="weekday">Choose a weekday, or leave blank to save the recipe for later:</label></p>
            <p><select id="weekday"
                       name="weekday"
                       v-model="weekday">
              <option></option>
              <option v-for="weekday in weekdays">{{ weekday }}</option>
            </select></p>
            <p>
              <input type="submit"
                     id="submit"
                     name="submit"
                     value="Save recipe"></p>
            <p>
              <button @click="clearForm" id="cancelForm">Cancel</button>
            </p>
          </form>
          <div id="placeholder"></div>
          <article v-show="showForm" id="reactive-recipe">
            <h2 v-show="title.length || ingredients.length">Your recipe:</h2>
            <h3>{{ title }}</h3>
            <ul>
              <li v-for="(ingredient, index) in ingredients"
                  :key="index">
                {{ ingredient.ingredientName }} : {{ ingredient.ingredientQty }}{{ ingredient.ingredientWeight }}
              </li>
            </ul>
          </article>
          <todays-recipe :recipes="recipes"></todays-recipe>
          <p v-show="showRecipeSavedMsg">Recipe saved!</p>
          </section>
        `,
        data() {
            return {
                showForm: false,
                showRecipeSavedMsg: false,
                showIngredientError: false,
                title: '',
                ingredientName: '',
                ingredientQty: '',
                ingredientWeight: '',
                ingredients: [],
                weekday: '',
                image: '',
                alt: ''
            }
        },
        methods: {
            displayForm() {
                eventBus.$emit('hide-others')
                this.showForm = true
                this.showRecipeSavedMsg = false
            },
            addIngredient() {
                if (!(this.ingredientWeight && this.ingredientQty)
                    && this.ingredientName) {
                    let ingredient = {
                        ingredientName: this.ingredientName,
                        ingredientQty: this.ingredientQty,
                        ingredientWeight: this.ingredientWeight
                    }
                    this.ingredients.push(ingredient)
                    this.clearIngredients()
                } else if (!this.ingredientName) {
                    this.showIngredientError = true
                }
            },
            //todo Gör så man kan välja vecka.
            addRecipe() {
                let recipe = {
                    title: this.title,
                    ingredients: this.ingredients.slice(),
                    weekday: this.weekday,
                    image: `img/${this.weekday}.jpg`,
                    alt: this.weekday,
                    position: function () {
                        switch (this.weekday) {
                            case 'monday':
                                return '2 / 1 / 3 / 2';
                            case 'tuesday':
                                return '2 / 2 / 3 / 3';
                            case 'wednesday':
                                return '2 / 3 / 3 / 4';
                            case 'thursday':
                                return '2 / 4 / 3 / 5';
                            case 'friday':
                                return '2 / 5 / 3 / 6';
                            case 'saturday':
                                return '2 / 6 / 3 / 7';
                            case 'sunday':
                                return '2 / 7 / 3 / 8';
                        }
                    }
                }
                this.removeDuplicates(recipe)
                this.clearForm()
                this.showRecipeSavedMsg = true

                this.$emit('save-recipe', recipe)
            },
            removeDuplicates(recipe) {
                for (let i = 0; i < this.recipes.length; i++) {
                    if (this.recipes[i].weekday === recipe.weekday) {
                        this.recipes[i].weekday = ''
                    }
                }
            },
            clearForm() {
                this.ingredients = []
                this.title = ''
                this.weekday = ''
                this.showForm = false
                this.clearIngredients()
            },
            clearIngredients() {
                this.ingredientQty = ''
                this.ingredientName = ''
                this.ingredientWeight = ''
                this.showIngredientError = false
            }
        },
        mounted() {
            eventBus.$on('hide-others', () => {
                this.showForm = false
                this.showRecipeSavedMsg = false
                this.showTodaysRecipe = false
            })
        }
    })

    Vue.component('todays-recipe', {
        props: {
            recipes: {
                type: Array,
                required: true
            }
        },
        template: `
          <article v-show="showTodaysRecipe">
          <h2>{{ todaysRecipe.weekday }}:</h2>
          <h3>{{ todaysRecipe.title }}</h3>
          <ul>
            <li v-for="ingredient in todaysRecipe.ingredients">
              {{ ingredient.ingredientName }} : {{ ingredient.ingredientQty }}{{ ingredient.ingredientWeight }}
            </li>
          </ul>
          </article>
        `,
        data() {
            return {
                showTodaysRecipe: false,
                todaysRecipe: ''
            }
        },
        methods: {
            displayTodaysRecipe(weekday) {
                this.showTodaysRecipe = true
                this.todaysRecipe = this.recipes.find(x => x.weekday === weekday)
            }
        },
        mounted() {
            eventBus.$on('hide-others', () => this.showTodaysRecipe = false)
            eventBus.$on('show-recipe', (weekday) => this.displayTodaysRecipe(weekday))
        }
    })

    Vue.component('recipe-list', {
        props: {
            recipes: {
                type: Array,
                required: true
            }
        },
        template: `
          <section id="recipe-list">
          <button v-show="!showRecipes" @click="displayRecipes">Show all recipes</button>
          <article id="recipes" v-show="showRecipes">
            <button @click="hideRecipes">Hide recipes</button>
            <ul>
              <li v-for="recipe in recipes"
                  :key recipe.title
                  @click="selectedTitle = recipe.title"
                  :class="{'active-title': selectedTitle === recipe.title}">
                <h3>{{ recipe.title }}</h3>
                <div v-show="selectedTitle === recipe.title">
                  <input type="image"
                         src="img/icon/outline_remove_circle_black_24dp.png"
                         alt="delete"
                         id="delete"
                         title="delete recipe"
                         @click="deleteRecipe">
                  <ul>
                    <li
                        v-for="(ingredient, index) in recipe.ingredients"
                        :key="index">
                      {{ ingredient.ingredientName }} : {{ ingredient.ingredientQty }}{{ ingredient.ingredientWeight }}
                    </li>
                  </ul>
                </div>
              </li>
            </ul>
          </article>
          </section>
        `,
        data() {
            return {
                showRecipes: false,
                selectedTitle: ''
            }
        },
        methods: {
            displayRecipes() {
                eventBus.$emit('hide-others')
                this.showRecipes = true
            },
            hideRecipes() {
                this.showRecipes = false
                this.selectedTitle = ''
            },
            deleteRecipe() {
                if (confirm('Are you sure you want to delete recipe: ' + this.selectedTitle + '?')) {
                    let pos = this.recipes.indexOf(this.selectedTitle)
                    this.recipes.splice(pos, 1)
                }
            }
        },
        mounted() {
            eventBus.$on('hide-others', () => this.showRecipes = false)
        }
    })

    Vue.component('shopping-list', {
        props: {
            recipes: {
                type: Array,
                required: true
            }
        },
        template: `
          <section>
          <button v-show="!showShoppingList" @click="displayShoppingList">Show this week's shopping list</button>
          <article id="shopping-list" v-show="showShoppingList">
            <button @click="hideShoppingList">Hide shopping list</button>
            <h2>This week's shopping list:</h2>
            <ul v-for="recipe in recipes"
                :key="recipe.title"
                v-if="recipe.weekday">
              <li
                  v-for="(ingredient, index) in recipe.ingredients"
                  :key="index">
                {{ ingredient.ingredientName }} : {{ ingredient.ingredientQty }}{{ ingredient.ingredientWeight }}
              </li>
            </ul>
          </article>
          </section>
        `,
        data() {
            return {
                showShoppingList: false
            }
        },
        methods: {
            displayShoppingList() {
                eventBus.$emit('hide-others')
                this.showShoppingList = true
            },
            hideShoppingList() {
                this.showShoppingList = false
            }
        },
        mounted() {
            eventBus.$on('hide-others', () => this.showShoppingList = false)
        }
    })

    let app = new Vue({
        el: '#app',
        data: {
            weekdays: ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'],
            recipes: [/*{
                title: 'potatis',
                weekday: 'wednesday',
                ingredients: [{ingredientName: 'potatis', ingredientQty: 4}],
                image: 'img/potato.jpg',
                alt: 'potato',
                position: function () {
                    switch (this.weekday) {
                        case 'monday':
                            return '2 / 1 / 3 / 2';
                        case 'tuesday':
                            return '2 / 2 / 3 / 3';
                        case 'wednesday':
                            return '2 / 3 / 3 / 4';
                        case 'thursday':
                            return '2 / 4 / 3 / 5';
                        case 'friday':
                            return '2 / 5 / 3 / 6';
                        case 'saturday':
                            return '2 / 6 / 3 / 7';
                        case 'sunday':
                            return '2 / 7 / 3 / 8';
                    }
                }
            }*/]
        },
        methods: {
            saveRecipe(recipe) {
                this.recipes.push(recipe)
            }
        }
    })
</script>
</body>
</html>